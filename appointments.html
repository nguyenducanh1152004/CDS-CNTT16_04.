{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-calendar-check me-2"></i>Quản Lý Lịch Hẹn</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAppointmentModal">
        <i class="fas fa-plus me-1"></i>Đặt Lịch Hẹn
    </button>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Bệnh Nhân</th>
                        <th>Bác Sĩ</th>
                        <th>Chuyên Khoa</th>
                        <th>Ngày Hẹn</th>
                        <th>Giờ Hẹn</th>
                        <th>Trạng Thái</th>
                        <th>Ghi Chú</th>
                        <th>Ngày Tạo</th>
                        <th>Thao Tác</th>
                    </tr>
                </thead>
                <tbody>
                    {% for appointment in appointments %}
                    <tr>
                        <td>{{ appointment.id }}</td>
                        <td>
                            <strong>{{ appointment.patient_name }}</strong>
                            <br><small class="text-muted">SDT: {{ appointment.patient_phone }}</small>
                        </td>
                        <td>{{ appointment.doctor_name }}</td>
                        <td>{{ appointment.specialization }}</td>
                        <td>{{ appointment.appointment_date }}</td>
                        <td>{{ appointment.appointment_time }}</td>
                        <td>
                            <select class="form-select form-select-sm status-select" 
                                   data-appointment-id="{{ appointment.id }}"
                                   onchange="updateStatus(this)">
                                <option value="Scheduled" {{ 'selected' if appointment.status == 'Scheduled' }}>Đã đặt</option>
                                <option value="Confirmed" {{ 'selected' if appointment.status == 'Confirmed' }}>Đã xác nhận</option>
                                <option value="Completed" {{ 'selected' if appointment.status == 'Completed' }}>Đã hoàn thành</option>
                                <option value="Cancelled" {{ 'selected' if appointment.status == 'Cancelled' }}>Đã hủy</option>
                            </select>
                        </td>
                        <td>{{ appointment.notes or 'N/A' }}</td>
                        <td>{{ appointment.created_at[:10] if appointment.created_at else 'N/A' }}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" data-appointment-id="{{ appointment.id }}" onclick="deleteAppointment(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="10" class="text-center text-muted">Chưa có lịch hẹn nào</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Appointment Modal -->
<div class="modal fade" id="addAppointmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Đặt Lịch Hẹn Mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="appointmentForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Chọn Bệnh Nhân *</label>
                                <select class="form-select" name="patient_id" required id="patientSelect">
                                    <option value="">-- Chọn bệnh nhân --</option>
                                    {% for patient in patients %}
                                    <option value="{{ patient.id }}" data-phone="{{ patient.phone }}" data-email="{{ patient.email }}">
                                        {{ patient.name }} - {{ patient.phone }}
                                    </option>
                                    {% endfor %}
                                    <option value="new">+ Thêm bệnh nhân mới</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Chọn Bác Sĩ *</label>
                                <select class="form-select" name="doctor_id" required id="doctorSelect">
                                    <option value="">-- Chọn bác sĩ --</option>
                                    {% for doctor in doctors %}
                                    <option value="{{ doctor.id }}" data-specialization="{{ doctor.specialization }}" 
                                            data-days="{{ doctor.available_days }}" data-time="{{ doctor.available_time }}">
                                        {{ doctor.name }} - {{ doctor.specialization }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text" id="doctorSchedule"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Form thêm bệnh nhân mới (ẩn ban đầu) -->
                    <div id="newPatientForm" style="display: none;">
                        <div class="alert alert-info">
                            <h6>Thông tin bệnh nhân mới</h6>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Họ Tên *</label>
                                    <input type="text" class="form-control" name="new_patient_name">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Số Điện Thoại *</label>
                                    <input type="tel" class="form-control" name="new_patient_phone">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="new_patient_email">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Ngày Hẹn *</label>
                                <input type="date" class="form-control" name="date" required id="appointmentDate">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Giờ Hẹn *</label>
                                <input type="time" class="form-control" name="time" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Trạng Thái</label>
                        <select class="form-select" name="status">
                            <option value="Scheduled">Đã đặt</option>
                            <option value="Confirmed">Đã xác nhận</option>
                            <option value="Completed">Đã hoàn thành</option>
                            <option value="Cancelled">Đã hủy</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ghi Chú / Triệu chứng</label>
                        <textarea class="form-control" name="notes" rows="3" placeholder="Mô tả triệu chứng hoặc ghi chú thêm..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="addAppointment()">Đặt Lịch</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Hiển thị lịch làm việc của bác sĩ khi chọn
document.getElementById('doctorSelect').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const scheduleDiv = document.getElementById('doctorSchedule');
    
    if (selectedOption.value) {
        const days = selectedOption.getAttribute('data-days');
        const time = selectedOption.getAttribute('data-time');
        scheduleDiv.innerHTML = `<small><strong>Lịch làm việc:</strong> ${days} | ${time}</small>`;
    } else {
        scheduleDiv.innerHTML = '';
    }
});

// Hiển thị form thêm bệnh nhân mới khi chọn
document.getElementById('patientSelect').addEventListener('change', function() {
    const newPatientForm = document.getElementById('newPatientForm');
    if (this.value === 'new') {
        newPatientForm.style.display = 'block';
        // Clear previous patient data
        document.querySelector('input[name="new_patient_name"]').value = '';
        document.querySelector('input[name="new_patient_phone"]').value = '';
        document.querySelector('input[name="new_patient_email"]').value = '';
    } else {
        newPatientForm.style.display = 'none';
    }
});

// Set min date to today
const today = new Date().toISOString().split('T')[0];
document.getElementById('appointmentDate').min = today;

function addAppointment() {
    const form = document.getElementById('appointmentForm');
    const formData = new FormData(form);
    
    const patientSelect = document.getElementById('patientSelect');
    const isNewPatient = patientSelect.value === 'new';
    
    const data = {
        patient_id: isNewPatient ? null : formData.get('patient_id'),
        doctor_id: formData.get('doctor_id'),
        date: formData.get('date'),
        time: formData.get('time'),
        status: formData.get('status'),
        notes: formData.get('notes')
    };

    // Thêm thông tin bệnh nhân mới nếu có
    if (isNewPatient) {
        data.new_patient = {
            name: formData.get('new_patient_name'),
            phone: formData.get('new_patient_phone'),
            email: formData.get('new_patient_email')
        };
    }

    if ((!data.patient_id && !data.new_patient) || !data.doctor_id || !data.date || !data.time) {
        alert('Vui lòng điền đầy đủ thông tin bắt buộc!');
        return;
    }

    if (isNewPatient && (!data.new_patient.name || !data.new_patient.phone)) {
        alert('Vui lòng điền đầy đủ thông tin bệnh nhân mới!');
        return;
    }

    fetch('/add_appointment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert(result.message);
            location.reload();
        } else {
            alert(result.message);
        }
    })
    .catch(error => {
        alert('Lỗi kết nối!');
    });
}

function updateStatus(select) {
    const appointmentId = select.getAttribute('data-appointment-id');
    const status = select.value;

    fetch('/update_appointment_status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            appointment_id: appointmentId,
            status: status
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert(result.message);
        } else {
            alert(result.message);
            location.reload();
        }
    });
}

function deleteAppointment(button) {
    const appointmentId = button.getAttribute('data-appointment-id');
    if (confirm('Bạn có chắc muốn xóa lịch hẹn này?')) {
        fetch(`/delete_appointment/${appointmentId}`)
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert(result.message);
                location.reload();
            } else {
                alert(result.message);
            }
        });
    }
}
</script>
{% endblock %}